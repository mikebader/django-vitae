{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>

<title>
{% block title %}
{% if cv_personal_info.name %}{{cv_personal_info.name}}--{% endif %}Django Vitae
{% endblock %}
</title>

<meta name="generator" content="Generated by Django Vitae">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
<link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">

<style type="text/css">
{% block styles %}
{% endblock styles %}
</style>

{% block scripts %}
<script
              src="https://code.jquery.com/jquery-3.3.1.min.js"
              integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
              crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
<!-- <script src="https://use.fontawesome.com/b7e617b38a.js"></script> -->
{% endblock scripts %}

{% block userstyles %}
<link rel="stylesheet" type="text/css" href="{% static 'cv/cv-main.css' %}" />  
<link rel="stylesheet" type="text/css" href="{% static 'cv/cv-forms.css' %}" />
{% endblock userstyles %}

</head>

<body>
    <div class="container">
{% block centerbar %}
{% endblock %}

{% block nav %}
        <div id="details" class="col-xs-12 details">
        {% block details %}{% endblock %}
        </div>

        <div id="next-previous" class="col-xs-12 clear-fix next-previous">
        {% block next-previous %}{% endblock %}
        </div> 
{% endblock nav %}
    </div>

{% block endscripts %}
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript">
    var addRe = /(\w+?)\-add/;
    var editRe = /(\w+?)\-edit/;

    function cancelButton(orig,editable){
            // Function to add cancel button to forms
            return $("<button>").attr("type","button").attr("class","btn btn-light").text("Cancel").click(function(event){
                orig.toggle();
                editable.toggle();
                editable.remove();
                        // event.preventDefault();
                    });
        }

        // ADD FORM ON CLICK TO ADD NEW INSTANCE 
        $(".cv-add").click(function(event){
            modelName = addRe.exec(this.className)[1];
            attrib = $(this).parent();

            orig = attrib.find("a");
            if ($("#"+modelName+"-add").length) {
                editable = $("#"+modelName+"-add")
            }
            else {
                editable = $("<div>").attr("id",modelName+"-add").addClass("editable");
                attrib.append(editable);
            }

            orig.toggle();
            editable.toggle();

            if(!editable.data("subMenuPopulated") && editable.is(":visible")){
                $.get("/cv/forms/"+modelName+"/add/",function(form){
                    cancel = cancelButton(orig,editable);
                    formpart = $($.parseHTML(form)).find('form');
                    editable.html(formpart).attr("class","alert alert-primary").data("subMenuPopulated",true);
                    editable.find(".save-group").append(cancel);
                });
            }
            inputSelector = '#' + modelName + '_short_title > input'
            attrib.on('keydown', inputSelector, function(event){
                slugify(this);
            });
            attrib.on('click', '#' + modelName + 'FormSubmit',
                function(event){
                    console.log(modelName);
                    formSubmit(this, modelName);

            });
        });

    function slugify(event) {
        // Mostly copied from Django admin js code (w/o unicode support and
        // internationalization):
        // https://github.com/django/django/blob/3c447b108ac70757001171f7a4791f493880bf5b/django/contrib/admin/static/admin/js/urlify.js
        var s = $(event).val();

        var slugField = $("#id_slug")
        var num_chars = slugField.attr("maxlength")

        var removelist = [
        "a", "an", "as", "at", "before", "but", "by", "for", "from", "is",
        "in", "into", "like", "of", "off", "on", "onto", "per", "since",
        "than", "the", "this", "that", "to", "up", "via", "with"
        ];

        var r = new RegExp('\\b(' + removelist.join('|') + ')\\b', 'gi');
        s = s.replace(r, '');    
        s = s.replace(/[^-\w\s]/g, ''); // remove unneeded chars    
        s = s.replace(/^\s+|\s+$/g, '');   // trim leading/trailing spaces
        s = s.replace(/[-\s]+/g, '-');     // convert spaces to hyphens
        s = s.toLowerCase();               // convert to lowercase

        $("#id_slug").val(s.substring(0, num_chars));
    };

    function formSubmit(event, modelName) {
        var form = $("#" + modelName + "Form")

        if (form[0].checkValidity() === false) {
            event.preventDefault()
            event.stopPropagation()
        }
        
        form.addClass('was-validated');
        form.attr("action", "/cv/forms/" + modelName + "/add/")
    }


//         // ADD FORM ON CLICK TO EVERY DIV WITH CLASS .cv-edit
//         $(".cv-edit").on("click",function() {
//             var modelName = editRe.exec(this.className)[1];
//             var attrib = $(this).closest("li");
//             var pk = attrib.attr("id").substring(modelName.length+1);

//             var $attrib = $("#"+attrib.attr("id"));

//             var orig = $attrib.find("div.noneditable");

//             var editable = $attrib.find("div.editable");

//             orig.toggle();
//             editable.toggle();

//             console.log(editable.data())

//             if(!editable.data("subMenuPopulated") && editable.is(":visible")){
//                 $.get("/cv/forms/"+modelName+"/"+pk+"/edit/",function(data){
//                     cancel = cancelButton(orig,editable);
//                     editable.html(data).attr("class","alert alert-primary editable").data("subMenuPopulated",true);
//                     editable.find(".save-group").append(cancel);
//                 });
//             }

//         });


//         $("#{{model}}FormSubmit").click(function(event) {

//     //Fetch form to apply custom Bootstrap validation
//     var form = $("#{{model}}Form")

//     if (form[0].checkValidity() === false) {
//         event.preventDefault()
//         event.stopPropagation()
//     }
    
//     form.addClass('was-validated');

// });


//         $("#id_short_title").keyup(function(event){
//      // Mostly copied from Django admin js code (w/o unicode support and
//     // internationalization):
//     // https://github.com/django/django/blob/3c447b108ac70757001171f7a4791f493880bf5b/django/contrib/admin/static/admin/js/urlify.js
//     var s = $(this).val();

//     var slugField = $("#id_slug")
//     var num_chars = slugField.attr("maxlength")
//     console.log(num_chars)

//     var removelist = [
//     "a", "an", "as", "at", "before", "but", "by", "for", "from", "is",
//     "in", "into", "like", "of", "off", "on", "onto", "per", "since",
//     "than", "the", "this", "that", "to", "up", "via", "with"
//     ];

//     var r = new RegExp('\\b(' + removelist.join('|') + ')\\b', 'gi');
//     s = s.replace(r, '');    
//     s = s.replace(/[^-\w\s]/g, ''); // remove unneeded chars    
//     s = s.replace(/^\s+|\s+$/g, '');   // trim leading/trailing spaces
//     s = s.replace(/[-\s]+/g, '-');     // convert spaces to hyphens
//     s = s.toLowerCase();               // convert to lowercase

//     $("#id_slug").val(s.substring(0, num_chars));
//     console.log(s.substring(0, num_chars));    
// });

//         $("select[name$='collaborator'").change(function(event){
//             var num = $(this).attr("id").match(/\d+/g);
//             var dispInput = $("#id_authorship-" + num + "-display_order")
//             if($(this).find(":selected").prop("value")!=="") {
//                 $(dispInput).prop("required",true);
//                 console.log(num);
//                 console.log("#id_authorship-" + num + "display_order")
//             }
//             else {
//                 $(dispInput).prop("required",false);
//                 console.log("false")
//             }
//         })
    </script>
{% endblock %}
</body>
</html>